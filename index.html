<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#0F0F12" />
    <title>MMA COMMAND | UFC • ONE • BKFC</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google GenAI Import Map -->
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai@1.40.0"
      }
    }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --bg-deep: #0F0F12;
            --bg-card: #1C1C21;
            --accent: #715A5A;
            --text-main: #E2E8F0;
            --text-dim: #64748B;
            --ufc: #D20A0A;
            --one: #FFD700;
            --bkfc: #0072CE;
        }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            background-image: 
                linear-gradient(rgba(113, 90, 90, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(113, 90, 90, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        .control-panel {
            background: rgba(15, 15, 18, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
        }

        .fighter-card {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
            overflow: hidden;
        }

        .fighter-card:hover {
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-4px);
            box-shadow: 0 20px 40px -15px rgba(0,0,0,0.7);
        }

        .date-header {
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .promo-indicator {
            height: 3px;
            width: 100%;
        }

        .indicator-ufc { background: var(--ufc); }
        .indicator-one { background: var(--one); }
        .indicator-bkfc { background: var(--bkfc); }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 0; }

        @keyframes subtle-pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.4; }
        }
        .updating-tag {
            animation: subtle-pulse 2s infinite;
        }
    </style>
</head>
<body class="min-h-screen pb-24 overflow-x-hidden selection:bg-[#715A5A]/50 selection:text-white">
    
    <div id="root">
        <!-- Persistent UI structure -->
        <header class="sticky top-0 z-[100] control-panel p-4 md:p-6">
            <div class="container mx-auto flex flex-col md:flex-row items-center justify-between gap-6">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-white/5 border border-white/10 flex items-center justify-center rounded-sm">
                        <span class="font-black italic text-xl text-[#715A5A]">M</span>
                    </div>
                    <div class="text-left">
                        <h1 class="text-xl font-black uppercase tracking-tighter leading-none">COMBAT INTELLIGENCE</h1>
                        <div class="flex items-center gap-2 mt-1" id="status-container">
                            <span class="w-1.5 h-1.5 bg-yellow-500 rounded-full animate-pulse"></span>
                            <span class="text-[8px] font-black text-slate-500 uppercase tracking-widest" id="status-text">INITIALIZING...</span>
                        </div>
                    </div>
                </div>
                
                <nav class="flex flex-wrap justify-center gap-1" id="promo-filters">
                    <!-- Filters populated by JS -->
                </nav>
            </div>
        </header>

        <main class="container mx-auto px-4 md:px-10 py-12 max-w-7xl">
            <div id="event-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8">
                <!-- Initial loading state -->
                <div class="col-span-full py-40 text-center opacity-20">
                    <p class="text-[10px] font-black uppercase tracking-[0.4em] italic">Accessing Combat Archives...</p>
                </div>
            </div>

            <section id="grounding-section" class="mt-24 pt-16 border-t border-white/5 max-w-4xl mx-auto hidden">
                <h3 class="text-[9px] font-black uppercase tracking-[0.4em] text-slate-500 mb-8 flex items-center gap-4">
                    <span class="h-px bg-white/5 flex-grow"></span>
                    Verified Signal Sources
                    <span class="h-px bg-white/5 flex-grow"></span>
                </h3>
                <div id="source-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
            </section>
        </main>

        <footer class="fixed bottom-0 left-0 right-0 bg-[#0F0F12]/95 backdrop-blur-md border-t border-white/5 p-3 flex justify-between items-center px-6 md:px-12 z-50">
            <div class="flex items-center gap-4">
                <span class="text-[8px] font-black uppercase tracking-[0.4em] text-slate-600">TRI-SECTOR FEED v10.0</span>
                <div class="h-2 w-px bg-white/10 hidden md:block"></div>
                <span class="text-[8px] font-black uppercase tracking-[0.2em] text-[#715A5A] font-bold">UFC • ONE • BKFC</span>
            </div>
            <span id="last-updated-text" class="text-[8px] font-black uppercase tracking-[0.2em] text-slate-500 mono">STANDBY</span>
        </footer>
    </div>

    <script type="module">
        import { GoogleGenAI, Type } from "@google/genai";

        const state = {
            events: [],
            sources: [],
            loading: false,
            error: null,
            selectedPromotion: null,
            lastUpdated: null
        };

        const CACHE_KEY = 'mma_tri_v10_cache';
        const CACHE_TIME = 1000 * 60 * 60 * 4; // 4 Hours

        const updateStatus = (text, isPulse = true) => {
            const statusText = document.getElementById('status-text');
            const statusDot = document.querySelector('#status-container span:first-child');
            if (statusText) statusText.innerText = text.toUpperCase();
            if (statusDot) {
                statusDot.className = `w-1.5 h-1.5 rounded-full ${isPulse ? 'bg-yellow-500 animate-pulse' : 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]'}`;
            }
        };

        const getLocalTime = (iso) => {
            if (!iso || iso === 'TBA') return { day: 'DATE PENDING', date: 'TBA', time: 'TBA' };
            const d = new Date(iso);
            if (isNaN(d.getTime())) return { day: 'INVALID DATE', date: iso.toUpperCase(), time: 'TBA' };
            
            return {
                day: d.toLocaleDateString('en-US', { weekday: 'LONG' }).toUpperCase(),
                date: d.toLocaleDateString('en-US', { month: 'SHORT', day: 'NUMERIC', year: 'numeric' }).toUpperCase(),
                time: d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true })
            };
        };

        const renderEvents = () => {
            const grid = document.getElementById('event-grid');
            const filters = document.getElementById('promo-filters');
            if (!grid) return;

            const filtered = state.selectedPromotion ? state.events.filter(e => e.promotion === state.selectedPromotion) : state.events;

            if (filtered.length === 0 && !state.loading) {
                grid.innerHTML = `<div class="col-span-full py-40 text-center opacity-40 italic uppercase text-[10px] tracking-widest">No verified future cards in local sector.</div>`;
            } else {
                grid.innerHTML = filtered.map(e => {
                    const t = getLocalTime(e.date);
                    const promoColorClass = `indicator-${e.promotion.toLowerCase().replace(/\s/g, '')}`;
                    
                    return `
                        <div class="fighter-card flex flex-col h-full">
                            <div class="promo-indicator ${promoColorClass}"></div>
                            <div class="date-header px-6 py-4 flex flex-col">
                                <span class="text-[14px] font-black text-white tracking-[0.2em] leading-none mb-1">${t.day}</span>
                                <div class="flex justify-between items-center">
                                    <span class="text-[11px] font-bold text-[#715A5A] mono">${t.date}</span>
                                    <span class="text-[10px] font-black bg-white/5 px-2 py-0.5 rounded-sm mono">${t.time}</span>
                                </div>
                            </div>

                            <div class="p-6 border-b border-white/5 bg-white/[0.01]">
                                <span class="text-[9px] font-black uppercase tracking-[0.3em] text-[#715A5A] mb-2 block">${e.promotion}</span>
                                <h2 class="text-xl font-black uppercase italic tracking-tighter leading-tight text-white mb-4 line-clamp-2">${e.eventName}</h2>
                            </div>

                            <div class="p-6 flex-grow space-y-5">
                                ${e.mainCard && e.mainCard.length > 0 ? e.mainCard.map(f => `
                                    <div class="relative ${f.isMainEvent ? 'pb-4 border-b border-white/5' : ''}">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-[8px] font-black text-slate-500 uppercase tracking-widest">${f.weightClass || 'BOUT'}</span>
                                            ${f.isMainEvent ? '<span class="text-[7px] font-black text-white bg-[#715A5A] px-1.5 py-0.5 rounded-sm">MAIN EVENT</span>' : ''}
                                        </div>
                                        <div class="flex items-center justify-between gap-2">
                                            <span class="text-xs font-black uppercase text-white truncate flex-1">${f.f1}</span>
                                            <span class="text-[9px] font-bold text-slate-700 italic px-1 shrink-0">VS</span>
                                            <span class="text-xs font-black uppercase text-white truncate flex-1 text-right">${f.f2}</span>
                                        </div>
                                    </div>
                                `).join('') : '<div class="py-10 text-center opacity-20 text-[9px] font-bold uppercase italic">Full Lineup Pending</div>'}
                            </div>

                            <div class="px-6 py-4 bg-black/40 border-t border-white/5 flex justify-between items-center text-[9px] font-bold uppercase tracking-widest text-slate-500">
                                <span class="truncate pr-2">${e.venue || 'TBA'}</span>
                                <span class="text-[#715A5A] shrink-0">${e.location || ''}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Update filters
            const promos = [...new Set(state.events.map(e => e.promotion))].sort();
            filters.innerHTML = `
                <button onclick="window.selectPromo(null)" class="px-3 py-1 text-[9px] font-black uppercase tracking-[0.2em] transition-all border border-transparent ${!state.selectedPromotion ? 'bg-white/10 border-white/10 text-white' : 'text-slate-500 hover:text-white'}">ALL_UNITS</button>
                ${promos.map(p => `
                    <button onclick="window.selectPromo('${p}')" class="px-3 py-1 text-[9px] font-black uppercase tracking-[0.2em] transition-all border border-transparent ${state.selectedPromotion === p ? 'bg-white/10 border-white/10 text-white' : 'text-slate-500 hover:text-white'}">${p}</button>
                `).join('')}
            `;

            // Update footer
            const lastSyncEl = document.getElementById('last-updated-text');
            if (lastSyncEl) lastSyncEl.innerText = state.lastUpdated ? `LAST_SYNC: ${new Date(state.lastUpdated).toLocaleTimeString()}` : 'STANDBY';

            // Grounding
            const groundingSection = document.getElementById('grounding-section');
            const sourceGrid = document.getElementById('source-grid');
            if (state.sources.length > 0) {
                groundingSection.classList.remove('hidden');
                sourceGrid.innerHTML = state.sources.map(s => `
                    <a href="${s.uri}" target="_blank" class="flex items-center justify-between p-3 bg-white/[0.02] border border-white/5 rounded-sm hover:border-white/20 transition-all group">
                        <span class="text-[10px] font-black uppercase tracking-tight text-slate-400 group-hover:text-white truncate pr-4">${s.title}</span>
                        <span class="text-[8px] mono text-[#715A5A] uppercase">${new URL(s.uri).hostname.replace('www.', '')}</span>
                    </a>
                `).join('');
            }
        };

        const fetchIntelligence = async () => {
            updateStatus("Synchronizing Signal...", true);
            const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
            
            const prompt = `COMMAND: AGGREGATE TRI-SECTOR MMA SCHEDULE
            TARGETS: UFC, ONE Championship, BKFC (Bare Knuckle Fighting Championship)
            DATE_CONTEXT: ${new Date().toDateString()}
            
            INSTRUCTIONS:
            1. Fetch only verified upcoming events for UFC, ONE, and BKFC.
            2. For each event, retrieve the official event name, date/time (ISO 8601), venue, and top 4 main card fights.
            3. Accuracy is mandatory. If a date is ambiguous, find the official promotion source.
            4. Return a JSON array of event objects.`;

            try {
                const response = await ai.models.generateContent({
                    model: "gemini-3-pro-preview",
                    contents: prompt,
                    config: {
                        tools: [{ googleSearch: {} }],
                        thinkingConfig: { thinkingBudget: 24000 }, 
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: Type.ARRAY,
                            items: {
                                type: Type.OBJECT,
                                properties: {
                                    promotion: { type: Type.STRING, enum: ['UFC', 'ONE Championship', 'BKFC'] },
                                    eventName: { type: Type.STRING },
                                    date: { type: Type.STRING },
                                    venue: { type: Type.STRING },
                                    location: { type: Type.STRING },
                                    mainCard: {
                                        type: Type.ARRAY,
                                        items: {
                                            type: Type.OBJECT,
                                            properties: {
                                                f1: { type: Type.STRING },
                                                f2: { type: Type.STRING },
                                                weightClass: { type: Type.STRING },
                                                isMainEvent: { type: Type.BOOLEAN }
                                            }
                                        }
                                    }
                                },
                                required: ['promotion', 'eventName', 'date', 'mainCard']
                            }
                        }
                    }
                });

                const grounding = response.candidates?.[0]?.groundingMetadata?.groundingChunks || [];
                state.sources = grounding.filter(c => c.web).map(c => ({ title: c.web.title, uri: c.web.uri }));
                
                const events = JSON.parse(response.text);
                state.events = events.sort((a,b) => new Date(a.date) - new Date(b.date));
                state.lastUpdated = Date.now();
                state.loading = false;
                
                localStorage.setItem(CACHE_KEY, JSON.stringify({ 
                    data: state.events, 
                    sources: state.sources, 
                    timestamp: state.lastUpdated 
                }));

                updateStatus("Signal Locked", false);
                renderEvents();
            